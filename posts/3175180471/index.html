<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: light)">
<meta name="theme-color" content="#222" media="(prefers-color-scheme: dark)"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha256-XOqroi11tY4EFQMR9ZYwZWKj5ZXiftSx36RRuC3anlA=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/themes/blue/pace-theme-minimal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pace/1.2.4/pace.min.js" integrity="sha256-gqd7YTjg/BtfqWSwsJOvndl0Bxc8gFImLEkXQT8+qj0=" crossorigin="anonymous"></script>

<script class="next-config" data-name="main" type="application/json">{"hostname":"momaoto.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":"auto","version":"8.20.0","exturl":false,"sidebar":{"position":"right","width_expanded":320,"width_dual_column":240,"display":"always","padding":18,"offset":12,"profile":{"enable":true,"tagline":"XJTU -> THU"}},"copycode":{"enable":true,"style":"flat"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="开源地址：https:&#x2F;&#x2F;gitee.com&#x2F;momaoto&#x2F;mpc_webots_emulation   原理介绍  机器人控制系统，就是要解决机器人在哪儿、去哪儿、怎么去的问题，分别对应了机器人控制系统的状态估计器、轨迹规划器和控制器。   原论文中第二章介绍了控制系统中的2.3步态调度、2.4状态估计、2.5质心轨迹生成、2.6摆动相规划，分别解决了在哪儿（状态估计）与去哪儿（轨迹规划）的">
<meta property="og:type" content="article">
<meta property="og:title" content="四足机器人MPC控制算法编写仿真">
<meta property="og:url" content="https://momaoto.github.io/posts/3175180471/index.html">
<meta property="og:site_name" content="momaoto&#39;s blog">
<meta property="og:description" content="开源地址：https:&#x2F;&#x2F;gitee.com&#x2F;momaoto&#x2F;mpc_webots_emulation   原理介绍  机器人控制系统，就是要解决机器人在哪儿、去哪儿、怎么去的问题，分别对应了机器人控制系统的状态估计器、轨迹规划器和控制器。   原论文中第二章介绍了控制系统中的2.3步态调度、2.4状态估计、2.5质心轨迹生成、2.6摆动相规划，分别解决了在哪儿（状态估计）与去哪儿（轨迹规划）的">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://momaoto.github.io/posts/3175180471/%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%80%BB%E6%A1%86%E5%9B%BE.png">
<meta property="og:image" content="https://momaoto.github.io/posts/3175180471/MPC%E5%8F%98%E9%87%8F%E4%BE%9D%E8%B5%96.png">
<meta property="article:published_time" content="2024-09-22T05:20:00.000Z">
<meta property="article:modified_time" content="2024-09-22T06:41:41.487Z">
<meta property="article:author" content="Momaoto">
<meta property="article:tag" content="笔记">
<meta property="article:tag" content="教程">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://momaoto.github.io/posts/3175180471/%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%80%BB%E6%A1%86%E5%9B%BE.png">


<link rel="canonical" href="https://momaoto.github.io/posts/3175180471/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":true,"permalink":"https://momaoto.github.io/posts/3175180471/","path":"posts/3175180471/","title":"四足机器人MPC控制算法编写仿真"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>四足机器人MPC控制算法编写仿真 | momaoto's blog</title>
  







<link rel="stylesheet" href="/css/callout_blocks.css">
  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">momaoto's blog</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-list fa-fw"></i>分类</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-inbox fa-fw"></i>归档</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%8E%9F%E7%90%86%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text"> 原理介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1"><span class="nav-number">2.</span> <span class="nav-text"> 框架设计</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A8%A1%E5%9D%97%E5%AE%9E%E7%8E%B0"><span class="nav-number">3.</span> <span class="nav-text"> 模块实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#paramsh"><span class="nav-number">3.1.</span> <span class="nav-text"> params.h</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gaitplannercpp"><span class="nav-number">3.2.</span> <span class="nav-text"> GaitPlanner.cpp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%AE%9A%E4%B9%89"><span class="nav-number">3.2.1.</span> <span class="nav-text"> 类定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="nav-number">3.2.2.</span> <span class="nav-text"> 使用方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#stateestimatorcpp"><span class="nav-number">3.3.</span> <span class="nav-text"> StateEstimator.cpp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%AE%9A%E4%B9%89-2"><span class="nav-number">3.3.1.</span> <span class="nav-text"> 类定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-2"><span class="nav-number">3.3.2.</span> <span class="nav-text"> 使用方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#trajectorygeneratorcpp"><span class="nav-number">3.4.</span> <span class="nav-text"> TrajectoryGenerator.cpp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%AE%9A%E4%B9%89-3"><span class="nav-number">3.4.1.</span> <span class="nav-text"> 类定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-3"><span class="nav-number">3.4.2.</span> <span class="nav-text"> 使用方法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#mpcsolvercpp"><span class="nav-number">3.5.</span> <span class="nav-text"> MPCsolver.cpp</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%B1%BB%E5%AE%9A%E4%B9%89-4"><span class="nav-number">3.5.1.</span> <span class="nav-text"> 类定义</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95-4"><span class="nav-number">3.5.2.</span> <span class="nav-text"> 使用方法</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="nav-number">4.</span> <span class="nav-text"> 控制器</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%94%B5%E6%9C%BA%E7%BC%96%E5%8F%B7%E8%AF%B4%E6%98%8E"><span class="nav-number">4.1.</span> <span class="nav-text"> 电机编号说明</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%94%AE%E7%9B%98%E8%BE%93%E5%85%A5"><span class="nav-number">4.2.</span> <span class="nav-text"> 键盘输入</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9D%E5%A1%9E%E5%B0%94%E6%9B%B2%E7%BA%BF"><span class="nav-number">4.3.</span> <span class="nav-text"> 贝塞尔曲线</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E5%8A%A8%E5%AD%A6%E9%80%86%E8%A7%A3"><span class="nav-number">4.4.</span> <span class="nav-text"> 运动学逆解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%BC%80%E5%A7%8B%E7%AC%AC%E4%B8%80%E4%B8%AAdemo"><span class="nav-number">4.5.</span> <span class="nav-text"> 开始第一个demo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B6%E4%BB%96"><span class="nav-number">5.</span> <span class="nav-text"> 其他</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#intel-mkl%E5%8A%A0%E9%80%9F"><span class="nav-number">5.1.</span> <span class="nav-text"> Intel  MKL加速</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E6%80%A7%E8%83%BD%E6%B5%8B%E9%87%8F"><span class="nav-number">5.2.</span> <span class="nav-text"> 代码性能测量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#eigen%E5%BA%93%E4%BD%BF%E7%94%A8"><span class="nav-number">5.3.</span> <span class="nav-text"> Eigen库使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#qpoases%E4%BD%BF%E7%94%A8"><span class="nav-number">5.4.</span> <span class="nav-text"> qpOASES使用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#webots%E6%89%8B%E5%86%8C"><span class="nav-number">5.5.</span> <span class="nav-text"> Webots手册</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#imu%E7%9B%B8%E5%85%B3"><span class="nav-number">5.6.</span> <span class="nav-text"> IMU相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2%E7%9B%B8%E5%85%B3"><span class="nav-number">5.7.</span> <span class="nav-text"> 卡尔曼滤波相关</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%97%A5%E5%BF%97"><span class="nav-number">6.</span> <span class="nav-text"> 日志</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Momaoto"
      src="/avatar.jpg">
  <p class="site-author-name" itemprop="name">Momaoto</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">6</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">10</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="/hekun.tian@qq.com" title="E-Mail → hekun.tian@qq.com" rel="noopener me"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://momaoto.github.io/posts/3175180471/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/avatar.jpg">
      <meta itemprop="name" content="Momaoto">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="momaoto's blog">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="四足机器人MPC控制算法编写仿真 | momaoto's blog">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          四足机器人MPC控制算法编写仿真
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2024-09-22 13:20:00 / 修改时间：14:41:41" itemprop="dateCreated datePublished" datetime="2024-09-22T13:20:00+08:00">2024-09-22</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%95%99%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">教程</span></a>
        </span>
    </span>

  
    <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv">
      <span class="post-meta-item-icon">
        <i class="far fa-eye"></i>
      </span>
      <span class="post-meta-item-text">阅读次数：</span>
      <span id="busuanzi_value_page_pv"></span>
    </span>
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>16k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>15 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><blockquote>
<p>开源地址：<a target="_blank" rel="noopener" href="https://gitee.com/momaoto/mpc_webots_emulation">https://gitee.com/momaoto/mpc_webots_emulation</a></p>
</blockquote>
<h2 id="原理介绍"><a class="markdownIt-Anchor" href="#原理介绍"></a> 原理介绍</h2>
<blockquote>
<p>机器人控制系统，就是要解决机器人在哪儿、去哪儿、怎么去的问题，分别对应了机器人控制系统的状态估计器、轨迹规划器和控制器。</p>
</blockquote>
<p><img src="%E6%8E%A7%E5%88%B6%E7%B3%BB%E7%BB%9F%E6%80%BB%E6%A1%86%E5%9B%BE.png" alt="" /></p>
<p>原论文中第二章介绍了控制系统中的2.3步态调度、2.4状态估计、2.5质心轨迹生成、2.6摆动相规划，分别解决了在哪儿（状态估计）与去哪儿（轨迹规划）的问题。第三章使用MPC对四足机器人控制量进行优化计算，解决机器人怎么去（模型预测控制）的问题。现对以上内容尝试c++面向对象的实现。</p>
<span id="more"></span>
<p>狗腿说明：</p>
<blockquote>
<p>狗头</p>
<p>2       1</p>
<p>4       3</p>
</blockquote>
<h2 id="框架设计"><a class="markdownIt-Anchor" href="#框架设计"></a> 框架设计</h2>
<ul>
<li><code>GaitPlanner</code>类：步态调度器，提供机器人<strong>步态变量输出</strong>，以供摆动相规划与支撑相控制。</li>
<li><code>StateEstimator</code>类：状态估计器，收集<strong>IMU与编码器返回的原始状态信息</strong>，加工并输出<strong>世界系下质心与四足的位置速度信息</strong>。</li>
<li><code>TrajectoryGenerator</code>类：质心轨迹生成器，接收遥控器的指令<strong>期望速度</strong>，生成<strong>期望轨迹</strong>。</li>
<li><code>MPCsolver</code>类：凸优化求解器，根据生成的估计状态与期望轨迹创建qp问题并求解，生成<strong>所需的足底反力</strong>。</li>
</ul>
<h2 id="模块实现"><a class="markdownIt-Anchor" href="#模块实现"></a> 模块实现</h2>
<p><em>以下为提供给用户使用的接口说明。</em></p>
<h3 id="paramsh"><a class="markdownIt-Anchor" href="#paramsh"></a> params.h</h3>
<p>这里定义了四足机器人全局静态参数，使用时预先在这里设置好：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _PARAMS_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _PARAMS_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 机器狗参数</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> H_X; <span class="comment">// (2.2)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> H_Y; <span class="comment">// (2.2)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> L_1; <span class="comment">// (2.2)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> L_2; <span class="comment">// (2.2)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> L_3; <span class="comment">// (2.2)</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> Mass ; <span class="comment">//质量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 控制周期</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> DELTA_T_MPC;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> DELTA_T_OTHERS;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREDICTION_HORIZON 10 <span class="comment">// 预测区间h</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> I_B_array[<span class="number">9</span>]; <span class="comment">// 机器狗惯性张量</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> kp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> p_x_offset; <span class="comment">// x方向落足点偏移量</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// MPC限制条件</span></span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> INF;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> f_max;</span><br><span class="line"><span class="keyword">extern</span> <span class="type">double</span> miu;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="gaitplannercpp"><a class="markdownIt-Anchor" href="#gaitplannercpp"></a> GaitPlanner.cpp</h3>
<blockquote>
<p>步态调度器，负责根据用户选择的步态模式计算输出每个控制周期四足的摆动相、支撑相相位，反映步态信息。</p>
</blockquote>
<h4 id="类定义"><a class="markdownIt-Anchor" href="#类定义"></a> 类定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _GAITPLANNER_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GAITPLANNER_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;params.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;global.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @brief The GaitPlanner class represents a gait planner for a quadruped robot.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This class is responsible for calculating the gait of the robot based on the</span></span><br><span class="line"><span class="comment"> * given parameters and current state.</span></span><br><span class="line"><span class="comment"> * It provides methods to set the gait parameters, set the robot&#x27;s state, set</span></span><br><span class="line"><span class="comment"> * the desired motion, and calculate the gait.</span></span><br><span class="line"><span class="comment"> * The calculated gait can be accessed through various getter methods.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GaitPlanner</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> t_; <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="type">int</span> n_;    <span class="comment">// 当前迈步周期数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Gait scheduler</span></span><br><span class="line">    <span class="type">int</span> setflag_; <span class="comment">// 调用函数前先设置步态</span></span><br><span class="line">    <span class="type">double</span> t_sw_; <span class="comment">// 名义摆动相时间</span></span><br><span class="line">    <span class="type">double</span> t_st_; <span class="comment">// 名义支撑相时间</span></span><br><span class="line"></span><br><span class="line">    Vector4d Gd_;      <span class="comment">// 占空比</span></span><br><span class="line">    Vector4d Go_;      <span class="comment">// 偏移量</span></span><br><span class="line">    <span class="type">double</span> T_gait_;    <span class="comment">// = t_sw + t_st; //完整迈步周期,=t_sw_+t_st_</span></span><br><span class="line">    <span class="type">double</span> t_ng_;      <span class="comment">// 当前周期的时间进度</span></span><br><span class="line">    <span class="type">double</span> t_ng_norm_; <span class="comment">// = t_ng / T_gait; //归一化当前周期时间进度</span></span><br><span class="line"></span><br><span class="line">    Vector4d t_fai_norm_; <span class="comment">// 相位进度,i=0,1,2,3</span></span><br><span class="line">    Vector4d s_fai_;      <span class="comment">// 是否处于支撑相,i=0,1,2,3</span></span><br><span class="line">    Vector4d t_st_norm_;  <span class="comment">// 支撑相相位进度,i=0,1,2,3</span></span><br><span class="line">    Vector4d t_sw_norm_;  <span class="comment">// 摆动相相位进度,i=0,1,2,3</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Swing phase planner</span></span><br><span class="line">    Vector3d p_touch_com_O_;</span><br><span class="line">    <span class="type">double</span> psi_touch_;</span><br><span class="line"></span><br><span class="line">    Vector3d p_t_com_O_;  <span class="comment">// position of com in O, 来自状态估计器</span></span><br><span class="line">    Vector3d v_t_com_O_;  <span class="comment">// velocity of com in O, 来自状态估计器</span></span><br><span class="line">    Matrix3d R_t_B_O_;    <span class="comment">// rotation matrix from B to O, 来自状态估计器</span></span><br><span class="line">    Vector3d omega_OB_O_; <span class="comment">// angular velocity of the robot, 来自状态估计器</span></span><br><span class="line">    <span class="type">double</span> psi_t_;        <span class="comment">// yaw angle of the robot, 来自状态估计器</span></span><br><span class="line"></span><br><span class="line">    Vector3d v_t_com_d_B_; <span class="comment">// desired velocity of com in B, 来自轨迹规划器</span></span><br><span class="line">    <span class="type">double</span> omega_t_z_d_;   <span class="comment">// desired yaw rate of the robot, 来自轨迹规划器</span></span><br><span class="line"></span><br><span class="line">    <span class="function">Vector3d <span class="title">getp_hip_i_B_</span><span class="params">(<span class="type">int</span> i)</span></span>;</span><br><span class="line">    <span class="function">Vector3d <span class="title">getp_touch_hip_i_O</span><span class="params">(<span class="type">int</span> i)</span></span>; <span class="comment">// 获取第i腿触地点在O系下的坐标,i=1,2,3,4</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">GaitPlanner</span>();</span><br><span class="line">    ~<span class="built_in">GaitPlanner</span>();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setGait</span><span class="params">(<span class="type">double</span> swingTime, <span class="type">double</span> standTime, string mode)</span></span>; <span class="comment">// 设置步态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calculateGait</span><span class="params">(<span class="type">double</span> currentTime)</span></span>;                        <span class="comment">// 计算步态</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(Vector3d p_t_com_O, Vector3d v_t_com_O, Matrix3d R_t_B_O,</span></span></span><br><span class="line"><span class="params"><span class="function">                  Vector3d omega_OB_O, <span class="type">double</span> <span class="type">psi_t</span>)</span></span>;          <span class="comment">// 设置状态</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setDesired</span><span class="params">(Vector3d v_t_com_d_B, <span class="type">double</span> omega_t_z_d)</span></span>; <span class="comment">// 设置期望</span></span><br><span class="line"></span><br><span class="line">    <span class="function">Vector3d <span class="title">getp_swend_i_O</span><span class="params">(<span class="type">int</span> i)</span></span>; <span class="comment">// 获取第i腿摆动末端在O系下的坐标,i=1,2,3,4</span></span><br><span class="line">    <span class="function">Vector4d <span class="title">gets_fai</span><span class="params">()</span></span>;            <span class="comment">// 获取当前各腿支撑相状态</span></span><br><span class="line">    <span class="comment">// Vector3d getp_stend_i_O(int i); // 获取四足最近一次支撑相足底坐标</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="使用方法"><a class="markdownIt-Anchor" href="#使用方法"></a> 使用方法</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未使用单例模式，因此写在main里，向线程函数传入引用</span></span><br><span class="line"> GaitPlanner *gp = <span class="keyword">new</span> <span class="built_in">GaitPlanner</span>(); </span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<h3 id="stateestimatorcpp"><a class="markdownIt-Anchor" href="#stateestimatorcpp"></a> StateEstimator.cpp</h3>
<blockquote>
<p>状态估计器，负责估计四足机器人运动过程中难以直接测量的状态信息，对IMU返回的原始旋转矩阵、电机编码器返回的角度与转速进行转换，反映四足机器人在世界系下的质心位置、质心速度、四足位置等状态信息。其中包括一个使用卡尔曼滤波实现的足底里程计，帮助MPC算法更加精确地收集状态信息。</p>
</blockquote>
<h4 id="类定义-2"><a class="markdownIt-Anchor" href="#类定义-2"></a> 类定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _STATEESTIMATOR_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _STATEESTIMATOR_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;params.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;global.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    状态估计器</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">StateEstimator</span> &#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">  <span class="type">double</span> t_; <span class="comment">// 当前时间</span></span><br><span class="line">  <span class="type">int</span> n_;    <span class="comment">// 当前为第n个周期</span></span><br><span class="line"></span><br><span class="line">  <span class="type">bool</span> IMUsetflag_;</span><br><span class="line">  <span class="type">bool</span> Encoderflag_;</span><br><span class="line">  <span class="type">bool</span> Calculatedflag_;</span><br><span class="line">  <span class="comment">// IMU</span></span><br><span class="line">  Vector3d a_com_B_;     <span class="comment">// B系质心加速度</span></span><br><span class="line">  Vector3d a_com_O_;     <span class="comment">// O系质心加速度</span></span><br><span class="line">  Vector3d omega_OB_B_;  <span class="comment">// B系躯干角速度</span></span><br><span class="line">  Vector3d omega_OB_O_;  <span class="comment">// O系躯干角速度</span></span><br><span class="line">  Matrix3d omega_OBX_B_; <span class="comment">// B系躯干角速度张量(2.51)</span></span><br><span class="line"></span><br><span class="line">  Vector3d p_i_B_;     <span class="comment">// 本体系下i足足底位置(2.47)</span></span><br><span class="line">  Vector3d p_dot_i_B_; <span class="comment">// 本体系下i足足底速度(2.49)</span></span><br><span class="line"></span><br><span class="line">  Matrix3d R_imu_imu0_;        <span class="comment">// imu-&gt;imu0旋转矩阵(IMU原始旋转矩阵)</span></span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; q_j_i_; <span class="comment">// 12个关节电机角度,电机编号见顶部</span></span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; q_dot_j_i_; <span class="comment">// 12个关节电机角速度,电机编号见顶部</span></span><br><span class="line">  Vector3d a_original_;            <span class="comment">// 原始IMU加速度</span></span><br><span class="line">  Vector3d omega_original_;        <span class="comment">// 原始IMU角速度</span></span><br><span class="line"></span><br><span class="line">  Matrix3d R_B_O_; <span class="comment">// B-&gt;O躯干旋转矩阵(通过IMU和世界系的定义计算得出)</span></span><br><span class="line">  Matrix3d R_B_imu_; <span class="comment">// B-&gt;imu旋转矩阵(常值)</span></span><br><span class="line"></span><br><span class="line">  Matrix3d R_imu0_O_;      <span class="comment">// imu0-&gt;O旋转矩阵(常值)</span></span><br><span class="line">  Matrix3d R_t0_imu_imu0_; <span class="comment">// 初始时刻IMU旋转矩阵(IMU启动时读出)</span></span><br><span class="line"></span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; p_stend_O_last_; <span class="comment">// 上一控制周期求得有效支撑相足底坐标</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Kalman filter</span></span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">18</span>&gt; A_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">3</span>&gt; B_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">18</span>&gt; Q_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">28</span>, <span class="number">28</span>&gt; R_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">28</span>, <span class="number">18</span>&gt; H_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">18</span>&gt; P_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">28</span>&gt; K_;</span><br><span class="line">  Vector3d u_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">28</span>, <span class="number">1</span>&gt; z_k_;</span><br><span class="line">  Matrix&lt;<span class="type">double</span>, <span class="number">18</span>, <span class="number">1</span>&gt; x_k_; <span class="comment">// k时刻状态变量[p_com_O, v_com_O, p_foot_O](18*1)</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Vector3d <span class="title">geta_com_B</span><span class="params">()</span></span>; <span class="comment">// 计算并返回质心加速度，参数为原始IMU加速度</span></span><br><span class="line">  <span class="function">Vector3d <span class="title">geta_com_O</span><span class="params">()</span></span>; <span class="comment">// 经过R_B_O_变换后的质心加速度(2.42)</span></span><br><span class="line">  <span class="function">Vector3d <span class="title">getomega_OB_B</span><span class="params">()</span></span>; <span class="comment">// 计算并返回躯干角速度，参数为原始IMU角速度</span></span><br><span class="line">  <span class="function">Vector3d <span class="title">getomega_OB_O</span><span class="params">()</span></span>; <span class="comment">// 经过R_B_O_变换后的躯干角速度(2.44)</span></span><br><span class="line"></span><br><span class="line">  <span class="function">Matrix3d <span class="title">getomega_OBX_B</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算本体系下i足足底位置(2.47)，参数q_j_i为第i条腿上的3个关节电机角度，0-髋电机，1-大腿电机，2-小腿电机</span></span><br><span class="line">  <span class="function">Vector3d <span class="title">getp_i_B</span><span class="params">(<span class="type">int</span> i, <span class="type">const</span> Vector3d &amp;q_j_i)</span></span>;</span><br><span class="line">  <span class="comment">// 计算本体系下i足足底速度(2.49)，参数q_dot_j_i为第i条腿上的3个关节电机速度，0-髋电机，1-大腿电机，2-小腿电机</span></span><br><span class="line">  <span class="function">Vector3d <span class="title">getp_dot_i_B</span><span class="params">(<span class="type">int</span> i, <span class="type">const</span> Vector3d &amp;q_j_i,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> Vector3d &amp;q_dot_j_i)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">  <span class="built_in">StateEstimator</span>();</span><br><span class="line">  ~<span class="built_in">StateEstimator</span>();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// void setIMUdata(const Matrix3d &amp;R_imu_imu0, const Vector3d &amp;a_original,</span></span><br><span class="line">  <span class="comment">// const Vector3d &amp;omega_original);</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 设置InertialUnit输出的欧拉角(原始旋转矩阵)，Gyro输出的角速度，Accelerometer输出的加速度</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setIMUdata</span><span class="params">(<span class="type">const</span> Vector3d &amp;Eulerangles, <span class="type">const</span> Vector3d &amp;a_original,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="type">const</span> Vector3d &amp;omega_original)</span></span>;</span><br><span class="line">  <span class="comment">// 设置12个关节电机角度和角速度</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">setEncoderdata</span><span class="params">(<span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; &amp;q_j_i,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; &amp;q_dot_j_i)</span></span>;</span><br><span class="line">  <span class="comment">// 计算所有过程变量</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">calculateAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 卡尔曼滤波计算x_k</span></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">kalman_update</span><span class="params">(<span class="type">int</span> times)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算并返回躯干旋转矩阵，对于spot来说即为原始IMU旋转矩阵</span></span><br><span class="line">  <span class="function">Matrix3d <span class="title">getR_B_O</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Matrix&lt;<span class="type">double</span>, 4, 3&gt; <span class="title">getp_stend_O</span><span class="params">(<span class="type">const</span> Vector4d &amp;s_fai)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 返回18*1向量，为[p_com_O(3*1), v_com_O(3*1), p_foot_O(12*1)]</span></span><br><span class="line">  <span class="function">Matrix&lt;<span class="type">double</span>, 18, 1&gt; <span class="title">getx_k</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Matrix&lt;<span class="type">double</span>, 4, 3&gt; <span class="title">getp_foot</span><span class="params">()</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="使用方法-2"><a class="markdownIt-Anchor" href="#使用方法-2"></a> 使用方法</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未使用单例模式，因此写在main里，向线程函数传入引用</span></span><br><span class="line">StateEstimator *se = <span class="keyword">new</span> <span class="built_in">StateEstimator</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于计算估计状态</span></span><br><span class="line">   se-&gt;<span class="built_in">setIMUdata</span>(Eulerangles, a_original, omega_original);</span><br><span class="line">   se-&gt;<span class="built_in">setEncoderdata</span>(q_j_i, q_dot_j_i);</span><br><span class="line">   se-&gt;<span class="built_in">calculateAll</span>();</span><br><span class="line">   se-&gt;<span class="built_in">kalman_update</span>();</span><br><span class="line">   </span><br><span class="line">*x_k = se-&gt;<span class="built_in">getx_k</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于读取中间状态</span></span><br><span class="line">se-&gt;<span class="built_in">getp_stend_O</span>(gp-&gt;<span class="built_in">gets_fai</span>());</span><br><span class="line">se-&gt;<span class="built_in">getR_B_O</span>();</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="trajectorygeneratorcpp"><a class="markdownIt-Anchor" href="#trajectorygeneratorcpp"></a> TrajectoryGenerator.cpp</h3>
<blockquote>
<p>质心轨迹生成器，负责接受手柄传来的控制命令，转化为MPC算法需要的未来h周期地机器人期望轨迹（状态），作为实际轨迹优化问题的目标。</p>
</blockquote>
<ul>
<li>接受：期望速度，期望角速度</li>
<li>返回：期望速度，期望角速度，期望位置，期望角位置（欧拉角）</li>
</ul>
<p>构造时默认当前周期为0， 接收到手柄传来的<strong>本体系下</strong>的期望速度与角速度后生成<strong>未来h周期</strong>的、<strong>世界系下</strong>的期望速度，角速度，位置，欧拉角。</p>
<p>每次生成期望轨迹后，预测区间右移一格，重新生成未来h周期期望轨迹。</p>
<h4 id="类定义-3"><a class="markdownIt-Anchor" href="#类定义-3"></a> 类定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _TRAJECTORYGENERATOR_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _TRAJECTORYGENERATOR_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;params.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;global.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;Eigen/Dense&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    质心轨迹生成器</span></span><br><span class="line"><span class="comment">        角标命名规则：右上角开始顺时针命名</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TrajectoryGenerator</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">double</span> t_;          <span class="comment">// 当前时间</span></span><br><span class="line">    <span class="type">int</span> n_;             <span class="comment">// 当前为第n个周期</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> setflag_;       <span class="comment">// 调用函数前先设置期望值</span></span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> block_para_; <span class="comment">// 堵转保护系数</span></span><br><span class="line"></span><br><span class="line">    <span class="type">double</span> v_x_d_B_;     <span class="comment">// 期望x速度(B系)</span></span><br><span class="line">    <span class="type">double</span> v_y_d_B_;     <span class="comment">// 期望y速度(B系)</span></span><br><span class="line">    <span class="type">double</span> omega_z_d_B_; <span class="comment">// 期望绕z角速度(B系)</span></span><br><span class="line"></span><br><span class="line">    Vector3d p_0_com_d_O_; <span class="comment">// 上一控制周期求得此刻期望位置</span></span><br><span class="line">    Vector3d v_0_com_d_O_; <span class="comment">// 上一控制周期求得此刻期望速度</span></span><br><span class="line">    Vector3d p_0_com_O_;   <span class="comment">// 此刻实际位置 // BUG</span></span><br><span class="line"></span><br><span class="line">    Vector3d v_k_com_d_O_; <span class="comment">// 期望质心速度(2.21)</span></span><br><span class="line">    Vector3d p_k_com_d_O_; <span class="comment">// 期望质心位置(2.63)</span></span><br><span class="line">    Vector3d omega_k_d_O_; <span class="comment">// 期望角速度(2.65)</span></span><br><span class="line">    Vector3d THETA_k_d_;   <span class="comment">// 期望欧拉角(2.76)</span></span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; D_;</span><br><span class="line">    <span class="comment">// slope estimate</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; p_stend_O_; <span class="comment">// 4条腿的最近一次支撑相足底坐标</span></span><br><span class="line">    Vector3d A_pla_hat_;                <span class="comment">// 估计的地面平面系数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">TrajectoryGenerator</span>();</span><br><span class="line">    ~<span class="built_in">TrajectoryGenerator</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 设置四足最近一次支撑相足底坐标，来自步态规划器</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setState</span><span class="params">(<span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">4</span>, <span class="number">3</span>&gt; &amp;p_stend_O)</span></span>;</span><br><span class="line">    <span class="comment">// 设置期望值，来自上位机或手柄</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setDesired</span><span class="params">(<span class="type">const</span> <span class="type">double</span> &amp;v_x, <span class="type">const</span> <span class="type">double</span> &amp;v_y, <span class="type">const</span> <span class="type">double</span> &amp;omega_z)</span></span>;</span><br><span class="line">    <span class="comment">// 计算期望轨迹向量:[THETA_k_d,p_k_com_d_O,v_k_com_d_O,omega_k_d_O]*PREDICTION_HORIZON，其中包括坡度估计</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calculateAll</span><span class="params">(<span class="type">const</span> Matrix3d &amp;Rot)</span></span>;</span><br><span class="line">    <span class="comment">// 返回期望轨迹向量(13h*1)</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">getD</span><span class="params">(Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; &amp;vectorForD)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">getpsi_k_d</span><span class="params">(Matrix&lt;<span class="type">double</span>, PREDICTION_HORIZON, <span class="number">1</span>&gt; &amp;vectorForpsi_k_d)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Vector3d *getv_k_com_d_O(int k, Matrix3d *Rot);</span></span><br><span class="line">    <span class="comment">// Vector3d *getp_k_com_d_O(int k, Vector3d *p_0_com_O, Matrix3d *Rot);</span></span><br><span class="line">    <span class="comment">// Vector3d *getomega_k_d_O();</span></span><br><span class="line">    <span class="comment">// Vector3d *getTHETA_k_d();</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h4 id="使用方法-3"><a class="markdownIt-Anchor" href="#使用方法-3"></a> 使用方法</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未使用单例模式，因此写在main里，向线程函数传入引用</span></span><br><span class="line">TrajectoryGenerator *tg = <span class="keyword">new</span> <span class="built_in">TrajectoryGenerator</span>(); <span class="comment">// </span></span><br><span class="line"></span><br><span class="line">   tg-&gt;<span class="built_in">setState</span>(se-&gt;<span class="built_in">getp_stend_O</span>(gp-&gt;<span class="built_in">gets_fai</span>()));</span><br><span class="line">   tg-&gt;<span class="built_in">setDesired</span>(v_x, v_y, omega_z);</span><br><span class="line">   tg-&gt;<span class="built_in">calculateAll</span>(se-&gt;<span class="built_in">getR_B_O</span>());</span><br><span class="line">   tg-&gt;<span class="built_in">getD</span>(*vecD);</span><br><span class="line">   tg-&gt;<span class="built_in">getpsi_k_d</span>(*psi_k_d);</span><br></pre></td></tr></table></figure>
<h3 id="mpcsolvercpp"><a class="markdownIt-Anchor" href="#mpcsolvercpp"></a> MPCsolver.cpp</h3>
<ul>
<li>目的：计算出当前时刻（t时刻）应当输入的控制量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span></li>
<li>约束：
<ol>
<li>输入<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>后系统状态与预期状态尽可能接近(误差最小)</li>
<li>所输入的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>本身尽可能小(输入最小)</li>
</ol>
</li>
</ul>
<p>控制以上两个约束的权重后，求<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>为一个二次凸优化问题，以下为MPC具体实现时所需要的变量推导：</p>
<p><img src="MPC%E5%8F%98%E9%87%8F%E4%BE%9D%E8%B5%96.png" alt="" /></p>
<p>根据前文实现的四个计算类编写代码，求出当前时刻最优输入控制量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>U</mi></mrow><annotation encoding="application/x-tex">U</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.10903em;">U</span></span></span></span>，其中第一列为所需足底反力。</p>
<h4 id="类定义-4"><a class="markdownIt-Anchor" href="#类定义-4"></a> 类定义</h4>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> _MPCSOLVER_H_</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _MPCSOLVER_H_</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;all.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;qpOASES.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">// using namespace qpOASES; // contain class &quot;Matrix&quot;,ambigurous with Eigen;</span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> Eigen;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MPCsolver</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    qpOASES::QProblem *qproblem;</span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; D_;                                 <span class="comment">// D(13h*1)</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">13</span>, <span class="number">1</span>&gt; x_0_;                                                    <span class="comment">// x_0(13*1)</span></span><br><span class="line">    DiagonalMatrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">13</span> * PREDICTION_HORIZON&gt; Q_;   <span class="comment">// Q(13h*13h),  <span class="doctag">NOTE:</span> Q_ is diagonal matrix</span></span><br><span class="line">    DiagonalMatrix&lt;<span class="type">double</span>, <span class="number">12</span> * PREDICTION_HORIZON, <span class="number">12</span> * PREDICTION_HORIZON&gt; R_;   <span class="comment">// R(12h*12h),  <span class="doctag">NOTE:</span> R_ is diagonal matrix</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">20</span> * PREDICTION_HORIZON, <span class="number">12</span> * PREDICTION_HORIZON, RowMajor&gt; C_; <span class="comment">// C(20h*12h),  <span class="doctag">NOTE:</span> row major storage</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">20</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; c_lb_;                              <span class="comment">// clb(20h*1)</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">20</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; c_ub_;                              <span class="comment">// cub(20h*1)</span></span><br><span class="line"></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">13</span>&gt; A_qp_;                             <span class="comment">// Aqp(13h*13)</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">12</span> * PREDICTION_HORIZON&gt; B_qp_;        <span class="comment">// Bqp(13h*12h)</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">12</span> * PREDICTION_HORIZON, <span class="number">12</span> * PREDICTION_HORIZON, RowMajor&gt; H_; <span class="comment">// H(12h*12h),  <span class="doctag">NOTE:</span> row major storage</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">12</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; g_;                                 <span class="comment">// g(13h*1)</span></span><br><span class="line">    Matrix&lt;<span class="type">double</span>, <span class="number">12</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; U_;                                 <span class="comment">// U(12h*1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MPCsolver</span>(<span class="comment">/* args */</span>);</span><br><span class="line">    ~<span class="built_in">MPCsolver</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化qp问题</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setD_and_x0</span><span class="params">(<span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">13</span> * PREDICTION_HORIZON, <span class="number">1</span>&gt; &amp;vecD,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">13</span>, <span class="number">1</span>&gt; &amp;x_0)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 计算A_qp_、B_qp_、H_、g_、C_</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">calculateAll</span><span class="params">(<span class="type">const</span> Matrix&lt;<span class="type">double</span>, PREDICTION_HORIZON, <span class="number">1</span>&gt; &amp;psi_k_d,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> Matrix&lt;<span class="type">double</span>, <span class="number">3</span> * PREDICTION_HORIZON, <span class="number">4</span>&gt; &amp;r_k_ix)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 卡尔曼滤波首次求解</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">qpSolveU_first</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 卡尔曼滤波后续求解</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">qpSolveU_next</span><span class="params">(Matrix&lt;<span class="type">double</span>, <span class="number">12</span>,<span class="number">1</span>&gt; &amp;U_optimal)</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="使用方法-4"><a class="markdownIt-Anchor" href="#使用方法-4"></a> 使用方法</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 未使用单例模式，因此写在main里，向线程函数传入引用</span></span><br><span class="line">MPCsolver *mpc = <span class="keyword">new</span> <span class="built_in">MPCsolver</span>();</span><br><span class="line"></span><br><span class="line">mpc-&gt;<span class="built_in">setD_and_x0</span>(*vecD, *x_0);</span><br><span class="line">mpc-&gt;<span class="built_in">calculateAll</span>(*psi_k_d, *r_k_ix);</span><br><span class="line">mpc-&gt;<span class="built_in">qpSolveU_first</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (robot-&gt;<span class="built_in">step</span>(<span class="number">4</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">    mpc-&gt;<span class="built_in">setD_and_x0</span>(*vecD, *x_0);</span><br><span class="line">    mpc-&gt;<span class="built_in">calculateAll</span>(*psi_k_d, *r_k_ix);</span><br><span class="line">    mpc-&gt;<span class="built_in">qpSolveU_next</span>(*f_MPC);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<h2 id="控制器"><a class="markdownIt-Anchor" href="#控制器"></a> 控制器</h2>
<h3 id="电机编号说明"><a class="markdownIt-Anchor" href="#电机编号说明"></a> 电机编号说明</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*  电机编号</span></span><br><span class="line"><span class="comment">            头</span></span><br><span class="line"><span class="comment">     9  5       4 8</span></span><br><span class="line"><span class="comment">        1       0</span></span><br><span class="line"><span class="comment">          |dog|</span></span><br><span class="line"><span class="comment">          |dog|</span></span><br><span class="line"><span class="comment">          |dog|</span></span><br><span class="line"><span class="comment">        3       2</span></span><br><span class="line"><span class="comment">     11 7       6 10</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="键盘输入"><a class="markdownIt-Anchor" href="#键盘输入"></a> 键盘输入</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (key) &#123;</span><br><span class="line"><span class="keyword">case</span> Keyboard::UP:</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;FORWARD&quot;</span> &lt;&lt; endl;</span><br><span class="line">  v_x = <span class="number">0.1</span>;</span><br><span class="line">  v_y = <span class="number">0</span>;</span><br><span class="line">  omega_z = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> Keyboard::DOWN:</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;BACKWARD&quot;</span> &lt;&lt; endl;</span><br><span class="line">  v_x = <span class="number">-0.1</span>;</span><br><span class="line">  v_y = <span class="number">0</span>;</span><br><span class="line">  omega_z = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> Keyboard::LEFT:</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;LEFT&quot;</span> &lt;&lt; endl;</span><br><span class="line">  v_x = <span class="number">0</span>;</span><br><span class="line">  v_y = <span class="number">0</span>;</span><br><span class="line">  omega_z = <span class="number">0.1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> Keyboard::RIGHT:</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;RIGHT&quot;</span> &lt;&lt; endl;</span><br><span class="line">  v_x = <span class="number">0</span>;</span><br><span class="line">  v_y = <span class="number">0</span>;</span><br><span class="line">  omega_z = <span class="number">-0.1</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line">  v_x = <span class="number">0</span>;</span><br><span class="line">  v_y = <span class="number">0</span>;</span><br><span class="line">  omega_z = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="贝塞尔曲线"><a class="markdownIt-Anchor" href="#贝塞尔曲线"></a> 贝塞尔曲线</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Vector3d <span class="title">cubicBezier3D</span><span class="params">(Vector3d &amp;p0, Vector3d &amp;p1, Vector3d &amp;p2, Vector3d &amp;p3,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">float</span> t)</span> </span>&#123;</span><br><span class="line">  Vector3d result;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++)</span><br><span class="line">    result[i] = (<span class="number">1</span> - t) * (<span class="number">1</span> - t) * (<span class="number">1</span> - t) * p0[i] +</span><br><span class="line">                <span class="number">3</span> * (<span class="number">1</span> - t) * (<span class="number">1</span> - t) * t * p1[i] +</span><br><span class="line">                <span class="number">3</span> * (<span class="number">1</span> - t) * t * t * p2[i] + t * t * t * p3[i];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="运动学逆解"><a class="markdownIt-Anchor" href="#运动学逆解"></a> 运动学逆解</h3>
<blockquote>
<p>位置控制的运动学逆解，将足端坐标、速度转化为电机转角、转速。</p>
</blockquote>
<p>原位控版本：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> DOG_SOLVE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DOG_SOLVE_H</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> M_PI 3.1415926</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> leg_length1  0.050<span class="comment">//单位为m</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> leg_length2  0.340</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> leg_length3  0.400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//extern float kp;</span></span><br><span class="line"><span class="comment">//extern float kd;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dog_pd</span>&#123;</span><br><span class="line">	<span class="type">float</span> kp;</span><br><span class="line">	<span class="type">float</span> kd;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> <span class="title class_">dog_pd</span> dog_pd[<span class="number">12</span>];<span class="comment">//每条腿的pd参数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dog_motor</span>&#123;</span><br><span class="line">	<span class="type">double</span> sol_gamma;</span><br><span class="line">	<span class="type">double</span> sol_alfa;</span><br><span class="line">	<span class="type">double</span> sol_beta;</span><br><span class="line">	<span class="type">double</span>  a1, l4; <span class="comment">// 计算的角度和长度(中间变量)</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> <span class="title class_">dog_motor</span> leg_angle[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dog_foot</span>&#123;</span><br><span class="line">	<span class="type">double</span> x;</span><br><span class="line">	<span class="type">double</span> y;</span><br><span class="line">	<span class="type">double</span> z;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> <span class="title class_">dog_foot</span> foot_position[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">dog_motor_ouput</span>&#123;</span><br><span class="line">	<span class="type">double</span> sol_gamma;</span><br><span class="line">	<span class="type">double</span> sol_alfa;</span><br><span class="line">	<span class="type">double</span> sol_beta;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">extern</span> <span class="keyword">struct</span> <span class="title class_">dog_motor_ouput</span> leg_angle_ouput[<span class="number">4</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">dog_solve</span><span class="params">()</span></span>; <span class="comment">// 运动学逆解</span></span><br><span class="line"><span class="comment">// void dog_solve_output();//把逆解计算出来的结果处理后输出给电机</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>推荐使用更精简版本：（更新于12.22）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Vector3d <span class="title">inverseKinematics</span><span class="params">(<span class="type">int</span> legNumber, Vector3d footPosition)</span> </span>&#123;</span><br><span class="line">  Vector3d motorAngles;</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> gamma, alfa, beta;</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> x = footPosition[<span class="number">0</span>];</span><br><span class="line">  <span class="type">double</span> y = footPosition[<span class="number">1</span>];</span><br><span class="line">  <span class="type">double</span> z = footPosition[<span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="type">double</span> ksi = (legNumber == <span class="number">1</span> || legNumber == <span class="number">3</span>) ? <span class="number">1</span> : <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  gamma = MY_PI - <span class="built_in">acos</span>(L1 / <span class="built_in">sqrt</span>(<span class="built_in">pow</span>(y, <span class="number">2</span>) + <span class="built_in">pow</span>(z, <span class="number">2</span>))) - <span class="built_in">atan</span>(-ksi * y / z);</span><br><span class="line"></span><br><span class="line">  <span class="type">float</span> L23 = <span class="built_in">sqrt</span>(<span class="built_in">pow</span>(x, <span class="number">2</span>) + <span class="built_in">pow</span>(y, <span class="number">2</span>) + <span class="built_in">pow</span>(z, <span class="number">2</span>) - <span class="built_in">pow</span>(L1, <span class="number">2</span>));</span><br><span class="line"></span><br><span class="line">  beta = <span class="built_in">acos</span>((<span class="built_in">pow</span>(L2, <span class="number">2</span>) + <span class="built_in">pow</span>(L3, <span class="number">2</span>) - <span class="built_in">pow</span>(L23, <span class="number">2</span>)) / (<span class="number">2</span> * L2 * L3));</span><br><span class="line"></span><br><span class="line">  alfa = <span class="built_in">acos</span>(x / L23) +</span><br><span class="line">         <span class="built_in">acos</span>((<span class="built_in">pow</span>(L2, <span class="number">2</span>) + <span class="built_in">pow</span>(L23, <span class="number">2</span>) - <span class="built_in">pow</span>(L3, <span class="number">2</span>)) / (<span class="number">2</span> * L2 * L23));</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> IK_TEST</span></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;x: &quot;</span> &lt;&lt; x &lt;&lt; <span class="string">&quot; y: &quot;</span> &lt;&lt; y &lt;&lt; <span class="string">&quot; z: &quot;</span> &lt;&lt; z &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="built_in">atan</span>((L1 * <span class="built_in">cos</span>(gamma) - z) / x) &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="built_in">asin</span>(<span class="built_in">sqrt</span>(<span class="built_in">pow</span>(L1 * <span class="built_in">sin</span>(gamma) - y, <span class="number">2</span>) + <span class="built_in">pow</span>(L1 * <span class="built_in">cos</span>(gamma) - z, <span class="number">2</span>)) /</span><br><span class="line">               L23)</span><br><span class="line">       &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;gamma: &quot;</span> &lt;&lt; gamma &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;L23: &quot;</span> &lt;&lt; L23 &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;beta: &quot;</span> &lt;&lt; beta &lt;&lt; endl;</span><br><span class="line">  cout &lt;&lt; <span class="string">&quot;alfa: &quot;</span> &lt;&lt; alfa &lt;&lt; endl;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> ZERO_OFFSET_SPOT</span></span><br><span class="line">  gamma = (legNumber == <span class="number">1</span> || legNumber == <span class="number">3</span>) ? gamma - MY_PI / <span class="number">2</span></span><br><span class="line">                                             : MY_PI / <span class="number">2</span> - gamma;</span><br><span class="line">  alfa = -alfa + (<span class="number">2</span> * MY_PI / <span class="number">3</span>);</span><br><span class="line">  beta = -beta + <span class="number">1.6</span>;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> TO_DEGREE</span></span><br><span class="line">  gamma = gamma * <span class="number">180</span> / MY_PI;</span><br><span class="line">  alfa = alfa * <span class="number">180</span> / MY_PI;</span><br><span class="line">  beta = beta * <span class="number">180</span> / MY_PI;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">  motorAngles[<span class="number">0</span>] = gamma;</span><br><span class="line">  motorAngles[<span class="number">1</span>] = alfa;</span><br><span class="line">  motorAngles[<span class="number">2</span>] = beta;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> motorAngles;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="开始第一个demo"><a class="markdownIt-Anchor" href="#开始第一个demo"></a> 开始第一个demo</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">trot_balanced</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Robot *robot = <span class="keyword">new</span> <span class="built_in">Robot</span>();</span><br><span class="line">  GaitPlanner *gp = <span class="keyword">new</span> <span class="built_in">GaitPlanner</span>();</span><br><span class="line">  TrajectoryGenerator *tg = <span class="keyword">new</span> <span class="built_in">TrajectoryGenerator</span>();</span><br><span class="line">  StateEstimator *se = <span class="keyword">new</span> <span class="built_in">StateEstimator</span>();</span><br><span class="line">  MPCsolver *mpc = <span class="keyword">new</span> <span class="built_in">MPCsolver</span>();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">init_global_variables</span>();</span><br><span class="line">  <span class="function">thread <span class="title">thread1</span><span class="params">(thread_trajectory_generate, robot, tg, se, gp)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">thread2</span><span class="params">(thread_state_estimate, robot, se, gp)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">thread3</span><span class="params">(thread_mpc_solver, robot, mpc)</span></span>;</span><br><span class="line">  <span class="function">thread <span class="title">thread4</span><span class="params">(thread_send_command, robot)</span></span>;</span><br><span class="line"></span><br><span class="line">  thread<span class="number">1.</span><span class="built_in">join</span>();</span><br><span class="line">  thread<span class="number">2.</span><span class="built_in">join</span>();</span><br><span class="line">  thread<span class="number">3.</span><span class="built_in">join</span>();</span><br><span class="line">  thread<span class="number">4.</span><span class="built_in">join</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> gp;</span><br><span class="line">  <span class="keyword">delete</span> tg;</span><br><span class="line">  <span class="keyword">delete</span> se;</span><br><span class="line">  <span class="keyword">delete</span> mpc;</span><br><span class="line">  <span class="keyword">delete</span> robot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">trot_balanced</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a class="markdownIt-Anchor" href="#其他"></a> 其他</h2>
<h3 id="intel-mkl加速"><a class="markdownIt-Anchor" href="#intel-mkl加速"></a> Intel  MKL加速</h3>
<p>在<code>#include</code>之后的预处理区添加以下代码，可利用intel硬件加速Eigen矩阵的计算：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用Intel MKL 线性代数库加速</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> EIGEN_USE_MKL_ALL</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EIGEN_USE_MKL_ALL</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> EIGEN_VECTORIZE_SSE4_2</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EIGEN_VECTORIZE_SSE4_2</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<ul>
<li>
<p>此外针对MIT cheetah software有相关<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/185693836">计算优化手段</a></p>
</li>
<li>
<p>MIT cheetah software<a target="_blank" rel="noopener" href="https://github.com/mit-biomimetics/Cheetah-Software/tree/master">源码</a></p>
</li>
</ul>
<h3 id="代码性能测量"><a class="markdownIt-Anchor" href="#代码性能测量"></a> 代码性能测量</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> time_print  <span class="comment">//需要打印系统时间时保留</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    时间测量函数</span></span><br><span class="line"><span class="comment">    用法：</span></span><br><span class="line"><span class="comment">        #include &lt;timetest.cpp&gt;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">        float tStart = timetest();</span></span><br><span class="line"><span class="comment">        //待测量代码段</span></span><br><span class="line"><span class="comment">        float tEnd = timetest();</span></span><br><span class="line"><span class="comment">        cout&lt;&lt;tEnd-tStart;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">float</span> <span class="title">timetest</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">auto</span> now = std::chrono::system_clock::<span class="built_in">now</span>();</span><br><span class="line">    <span class="comment">// 通过不同精度获取相差的毫秒数</span></span><br><span class="line">    <span class="type">uint64_t</span> dis_millseconds =</span><br><span class="line">    std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::milliseconds&gt;(now.<span class="built_in">time_since_epoch</span>()).<span class="built_in">count</span>()</span><br><span class="line">    -</span><br><span class="line">    std::chrono::<span class="built_in">duration_cast</span>&lt;std::chrono::seconds&gt;(now.<span class="built_in">time_since_epoch</span>()).<span class="built_in">count</span>()</span><br><span class="line">    * <span class="number">1000</span>;</span><br><span class="line">    <span class="type">time_t</span> tt = std::chrono::system_clock::<span class="built_in">to_time_t</span>(now);</span><br><span class="line">    <span class="keyword">auto</span> time_tm = <span class="built_in">localtime</span>(&amp;tt);</span><br><span class="line">    <span class="type">char</span> strTime[<span class="number">25</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">float</span> ttt = time_tm-&gt;tm_hour * <span class="number">3600</span> + time_tm-&gt;tm_min * <span class="number">60</span> +</span><br><span class="line">    time_tm-&gt;tm_sec + <span class="number">0.001</span>*(<span class="type">float</span>)dis_millseconds;</span><br><span class="line">    <span class="meta">#<span class="keyword">ifdef</span> time_print</span></span><br><span class="line">    <span class="built_in">sprintf</span>(strTime, <span class="string">&quot;%d-%02d-%02d %02d:%02d:%02d %03d&quot;</span>, time_tm-&gt;tm_year +</span><br><span class="line">    <span class="number">1900</span>, time_tm-&gt;tm_mon + <span class="number">1</span>, time_tm-&gt;tm_mday, time_tm-&gt;tm_hour,</span><br><span class="line">    time_tm-&gt;tm_min, time_tm-&gt;tm_sec, (<span class="type">int</span>)dis_millseconds);</span><br><span class="line">    std::cout &lt;&lt; strTime &lt;&lt; std::endl;</span><br><span class="line">    <span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ttt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="eigen库使用"><a class="markdownIt-Anchor" href="#eigen库使用"></a> Eigen库使用</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">matrix.<span class="built_in">block</span>&lt;p,q&gt;(i,j);  <span class="comment">//从坐标(i,j)提取大小为&lt;p,q&gt;的块，可读可写</span></span><br></pre></td></tr></table></figure>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/293023673">快速入门矩阵运算——开源库Eigen</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/414383770">C++矩阵库Eigen的用法</a></li>
</ul>
<h3 id="qpoases使用"><a class="markdownIt-Anchor" href="#qpoases使用"></a> qpOASES使用</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_40709533/article/details/86064148">qpOASES使用说明</a></li>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/458087154">QPOASES使用</a></li>
</ul>
<h3 id="webots手册"><a class="markdownIt-Anchor" href="#webots手册"></a> Webots手册</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://cyberbotics.com/doc/guide/spot?version=R2020b-rev1#!">Webots User Guide</a></li>
</ul>
<h3 id="imu相关"><a class="markdownIt-Anchor" href="#imu相关"></a> IMU相关</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/344884686">IMU模块中的一些基本概念和常见问题</a></li>
</ul>
<h3 id="卡尔曼滤波相关"><a class="markdownIt-Anchor" href="#卡尔曼滤波相关"></a> 卡尔曼滤波相关</h3>
<ul>
<li><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/37750839">卡尔曼滤波中关键参数的调整</a></li>
<li><a target="_blank" rel="noopener" href="https://www.zhihu.com/question/47559783">怎样才叫真正理解卡尔曼滤波 Kalman Filter？</a></li>
</ul>
<h2 id="日志"><a class="markdownIt-Anchor" href="#日志"></a> 日志</h2>
<ul>
<li>11.19 构建第二章代码框架</li>
<li>11.20 实现<code>GaitScheduler</code>，增加性能测试函数</li>
<li>11.22 添加Eigen矩阵计算库，添加开源协议，开始实现<code>StateEstimator</code></li>
<li>11.23 实现<code>StateEstimator</code>卡尔曼滤波前的部分</li>
<li>11.24 实现<code>StateEstimator</code>卡尔曼滤波状态方程部分，完善readme<code>GaitScheduler</code>部分</li>
<li>11.28 实现<code>StateEstimator</code>完成(含卡尔曼滤波)，通过初步测试</li>
<li>11.30 实现<code>TrajectoryGenerator</code>至地形坡度估计，暂时跳过</li>
<li>12.02 分析MPC算法具体实现逻辑</li>
<li>12.06 搭建MPC算法框架</li>
<li>12.10 实现MPC初版代码</li>
<li>12.25 Webots仿真移植成功</li>
</ul>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/%E7%AC%94%E8%AE%B0/" rel="tag"># 笔记</a>
              <a href="/tags/%E6%95%99%E7%A8%8B/" rel="tag"># 教程</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/posts/2825630907/" rel="prev" title="HAL：CamX-CHI">
                  <i class="fa fa-angle-left"></i> HAL：CamX-CHI
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/posts/185323312/" rel="next" title="一次闲聊">
                  一次闲聊 <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa-solid fa-palette"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Momaoto</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">89k</span>
  </span>
</div>
<div class="busuanzi-count">
    <span class="post-meta-item" id="busuanzi_container_site_uv">
      <span class="post-meta-item-icon">
        <i class="fa fa-user-group"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-item" id="busuanzi_container_site_pv">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div><script color="190,190,190" opacity="0.8" zIndex="-1" count="100" src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1/dist/canvas-nest.js"></script>


    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/sidebar.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>





  <script src="/js/third-party/pace.js"></script>


  
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>




  

  <script class="next-config" data-name="enableMath" type="application/json">false</script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.9/katex.min.css" integrity="sha256-UF1fgpAiu3tPJN/uCqEUHNe7pnr+QR0SQDNfgglgtcM=" crossorigin="anonymous">



</body>
</html>
